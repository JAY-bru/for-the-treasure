<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>为了宝藏—核心战斗</title>
    <!-- 加载 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 加载 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 加载 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #020617; }
        .animate-spin-slow { animation: spin 0.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #292524; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #57534e; border-radius: 4px; }
        
        .animate-bounce-short { animation: bounce-short 1s ease-in-out forwards; }
        @keyframes bounce-short {
          0%, 100% { transform: translateY(0); opacity: 0; }
          20% { transform: translateY(-30px) scale(1.2); opacity: 1; }
          80% { opacity: 1; }
        }
        
        /* ----------------特效动画---------------- */
        /* 受击震动 */
        .shake-effect { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-3px, 0, 0) rotate(-1deg); }
            20%, 80% { transform: translate3d(4px, 0, 0) rotate(1deg); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0) rotate(-2deg); }
            40%, 60% { transform: translate3d(6px, 0, 0) rotate(2deg); }
        }
        /* 斩击视觉特效 */
        .slash-effect {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.9) 48%, rgba(220,38,38,0.7) 50%, transparent 55%);
            background-size: 200% 200%;
            animation: slash 0.3s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
            pointer-events: none;
            z-index: 40;
            border-radius: 0.5rem;
        }
        @keyframes slash {
            0% { background-position: 200% 0; opacity: 0; }
            50% { opacity: 1; }
            100% { background-position: -50% 100%; opacity: 0; }
        }
        /* 治疗光环特效 */
        .heal-effect {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, rgba(74,222,128,0.5) 0%, transparent 70%);
            animation: pulse-heal 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 40;
            border-radius: 0.5rem;
        }
        @keyframes pulse-heal {
            0% { transform: scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        /* ------------------------------------------- */

        /* 背景粒子 */
        .particle {
          position: absolute;
          background: rgba(255, 180, 100, 0.4);
          border-radius: 50%;
          filter: blur(1px);
          animation: float 10s infinite ease-in-out;
        }
        .p1 { width: 4px; height: 4px; left: 20%; top: 80%; animation-delay: 0s; }
        .p2 { width: 3px; height: 3px; left: 70%; top: 60%; animation-delay: 2s; }
        .p3 { width: 5px; height: 5px; left: 40%; top: 40%; animation-delay: 4s; }
        .p4 { width: 2px; height: 2px; left: 80%; top: 20%; animation-delay: 1s; }
        @keyframes float {
          0% { transform: translateY(0) translateX(0); opacity: 0; }
          20% { opacity: 0.8; }
          80% { opacity: 0.8; }
          100% { transform: translateY(-100px) translateX(20px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 简易图标组件 ---
        const Icon = ({ path, className="w-[18px] h-[18px]" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d={path} />
            </svg>
        );
        const Icons = {
            Sword: () => <Icon path="M14.5 17.5L3 6V3h3l11.5 11.5" />,
            Zap: () => <Icon path="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            Wind: () => <Icon path="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2" />,
            Music: () => <Icon path="M9 18V5l12-2v13" />,
            Play: () => <Icon path="M5 3l14 9-14 9V3z" />,
            RotateCcw: () => <Icon path="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />,
            Target: () => <Icon path="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0-6 0" />
        };

        const ANIMATION_SPEED = 50;
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // --- 角色 SVG ---
        const KnightFigure = () => (
            <svg viewBox="0 0 100 100" className="w-20 h-20 drop-shadow-2xl filter hover:brightness-110 transition-all z-10">
                <defs>
                    <linearGradient id="armorGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#e2e8f0" /><stop offset="50%" stopColor="#94a3b8" /><stop offset="100%" stopColor="#475569" />
                    </linearGradient>
                    <linearGradient id="visorGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#1e293b" /><stop offset="100%" stopColor="#0f172a" />
                    </linearGradient>
                </defs>
                <ellipse cx="50" cy="95" rx="30" ry="8" fill="black" opacity="0.5" filter="blur(4px)"/>
                <path d="M50 25 C30 25 25 45 25 55 C25 75 30 90 20 95 L80 95 C70 90 75 75 75 55 C75 45 70 25 50 25" fill="url(#armorGradient)" stroke="#1e293b" strokeWidth="2"/>
                <path d="M35 55 Q50 65 65 55" stroke="#3b82f6" strokeWidth="4" fill="none" />
                <circle cx="50" cy="35" r="18" fill="url(#armorGradient)" stroke="#1e293b" strokeWidth="2"/>
                <rect x="41" y="30" width="18" height="6" rx="2" fill="url(#visorGradient)" />
                <path d="M50 17 L50 10" stroke="#f59e0b" strokeWidth="3" />
                <path d="M50 10 Q65 0 70 15" stroke="#dc2626" strokeWidth="4" fill="none" strokeLinecap="round" />
            </svg>
        );

        const MageFigure = () => (
            <svg viewBox="0 0 100 100" className="w-20 h-20 drop-shadow-2xl filter hover:brightness-110 transition-all z-10">
                <ellipse cx="50" cy="95" rx="30" ry="8" fill="black" opacity="0.5" filter="blur(4px)"/>
                <path d="M35 85 L25 45 L50 35 L75 45 L65 85 Z" fill="#4c1d95" stroke="#2e1065" strokeWidth="2"/>
                <circle cx="50" cy="35" r="16" fill="#1e1b4b"/>
                <path d="M34 35 Q50 15 66 35 Q50 50 34 35" fill="#a855f7"/>
                <path d="M75 25 L65 95" stroke="#78350f" strokeWidth="4"/>
                <circle cx="75" cy="25" r="8" fill="#fbbf24" className="animate-pulse"/>
            </svg>
        );

        const GoblinFigure = () => (
            <svg viewBox="0 0 100 100" className="w-20 h-20 drop-shadow-2xl filter hover:brightness-110 transition-all z-10">
                <defs>
                    <linearGradient id="goblinSkin" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#86efac" /><stop offset="100%" stopColor="#166534" />
                    </linearGradient>
                    <linearGradient id="leather" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#a16207" /><stop offset="100%" stopColor="#451a03" />
                    </linearGradient>
                </defs>
                <ellipse cx="50" cy="95" rx="30" ry="8" fill="black" opacity="0.5" filter="blur(4px)"/>
                <path d="M30 40 L10 30 L30 50 Z" fill="#4ade80" stroke="#14532d" strokeWidth="2"/>
                <path d="M70 40 L90 30 L70 50 Z" fill="#4ade80" stroke="#14532d" strokeWidth="2"/>
                <path d="M50 35 C30 40 30 55 30 65 C30 85 25 90 25 95 L75 95 C75 90 70 85 70 65 C70 55 70 40 50 35" fill="url(#leather)" stroke="#2a1205" strokeWidth="2"/>
                <circle cx="50" cy="40" r="17" fill="url(#goblinSkin)" stroke="#14532d" strokeWidth="2"/>
                <path d="M43 38 L48 40 L43 42" fill="#ef4444" />
                <path d="M57 38 L52 40 L57 42" fill="#ef4444" />
                <path d="M45 48 Q50 45 55 48" stroke="#14532d" strokeWidth="2" fill="none"/>
                <path d="M48 50 L50 53 L52 50" fill="#fff" />
            </svg>
        );

        // --- 主程序 ---
        function App() {
            const [players, setPlayers] = useState([
                {
                    id: 'p1', type: 'player', name: '流浪骑士', maxHp: 50, hp: 50, armor: 1, img: <KnightFigure />,
                    attacks: [
                        { id: 1, name: '突刺', type: 'attack', baseDmg: 8, icon: <Icons.Sword />, desc: '点数≥4连击' },
                        { id: 2, name: '重击', type: 'attack', baseDmg: 14, icon: <Icons.Zap />, desc: '高伤波动大' }
                    ]
                },
                {
                    id: 'p2', type: 'player', name: '奥术法师', maxHp: 35, hp: 35, armor: 0, img: <MageFigure />,
                    attacks: [
                        { id: 3, name: '浪子吼叫', type: 'attack', baseDmg: 10, icon: <Icons.Wind />, desc: '声波冲击' },
                        { id: 4, name: '馄饨店热舞', type: 'heal', baseDmg: 5, icon: <Icons.Music />, desc: '全队微量恢复' }
                    ]
                }
            ]);

            const [enemies, setEnemies] = useState([
                { 
                    id: 'e1', type: 'enemy', name: '哥布林刺客', maxHp: 40, hp: 40, img: <GoblinFigure />, atkBase: 6,
                    skills: ['淬毒匕首', '背刺'] // AI会使用这些技能
                },
                { 
                    id: 'e2', type: 'enemy', name: '哥布林弓手', maxHp: 30, hp: 30, img: <GoblinFigure />, atkBase: 5,
                    skills: ['蓄力箭', '散射']
                }
            ]);

            const [turnQueue] = useState(['p1', 'p2', 'e1', 'e2']); 
            const [turnIndex, setTurnIndex] = useState(0); 
            const activeUnitId = turnQueue[turnIndex];
            const activeUnit = [...players, ...enemies].find(u => u.id === activeUnitId);

            const [phase, setPhase] = useState('start'); 
            const [logs, setLogs] = useState(['战斗开始！遭遇了一群 哥布林！']);
            const [floatingTexts, setFloatingTexts] = useState([]);
            
            // 新增特效状态
            const [visualEffects, setVisualEffects] = useState([]);

            const [diceValue, setDiceValue] = useState(1);
            const [selectedAttack, setSelectedAttack] = useState(null);
            const [selectedTarget, setSelectedTarget] = useState(null);
            const [showDice, setShowDice] = useState(false);

            const addLog = (text) => setLogs(prev => [text, ...prev].slice(0, 10));

            const showFloatingText = (unitId, value, type) => {
                const id = Date.now() + Math.random();
                setFloatingTexts(prev => [...prev, { id, unitId, value, type }]);
                setTimeout(() => setFloatingTexts(prev => prev.filter(ft => ft.id !== id)), 1000);
            };

            // 触发受击/治疗动画的辅助函数
            const triggerEffect = (unitId, effectType) => {
                const id = Date.now() + Math.random();
                setVisualEffects(prev => [...prev, { id, unitId, type: effectType }]);
                setTimeout(() => {
                    setVisualEffects(prev => prev.filter(e => e.id !== id));
                }, effectType === 'heal' ? 600 : 400); 
            };

            const advanceTurn = () => {
                let nextIdx = (turnIndex + 1) % turnQueue.length;
                let sanity = 0;
                while (sanity < turnQueue.length) {
                    const id = turnQueue[nextIdx];
                    const unit = [...players, ...enemies].find(u => u.id === id);
                    if (unit && unit.hp > 0) break;
                    nextIdx = (nextIdx + 1) % turnQueue.length;
                    sanity++;
                }
                setTurnIndex(nextIdx);
                setPhase('idle');
                setShowDice(false);
            };

            useEffect(() => {
                if (phase === 'start' || phase === 'win' || phase === 'lose') return;
                const alivePlayers = players.some(p => p.hp > 0);
                const aliveEnemies = enemies.some(e => e.hp > 0);
                
                if (!alivePlayers) { setPhase('lose'); addLog('队伍全军覆没...'); setShowDice(false); }
                else if (!aliveEnemies) { setPhase('win'); addLog('敌人全被消灭了，胜利！'); setShowDice(false); }
            }, [players, enemies, phase]);

            const handleAttackSelect = (attack) => {
                if (phase !== 'idle' || activeUnit?.type !== 'player') return;
                
                if (attack.type === 'heal') {
                    setSelectedAttack(attack);
                    setPhase('rolling');
                    setShowDice(true);
                    addLog(`${activeUnit.name} 准备使用 ${attack.name}...`);
                } else {
                    setSelectedAttack(attack);
                    setPhase('target-selection');
                    addLog(`请选择 [${attack.name}] 的目标...`);
                }
            };

            const handleTargetSelect = (enemyTarget) => {
                if (phase !== 'target-selection') return;
                setSelectedTarget(enemyTarget);
                setPhase('rolling');
                setShowDice(true);
            };

            useEffect(() => {
                if (phase === 'rolling' && selectedAttack) {
                    let rolls = 0;
                    const interval = setInterval(() => {
                        setDiceValue(randomInt(1, 6));
                        rolls++;
                        if (rolls > 15) {
                            clearInterval(interval);
                            finalizeAction();
                        }
                    }, ANIMATION_SPEED);
                    return () => clearInterval(interval);
                }
            }, [phase, selectedAttack]);

            const finalizeAction = () => {
                const finalRoll = randomInt(1, 6);
                setDiceValue(finalRoll);
                
                let multiplier = 1; let textType = 'normal';
                if (finalRoll <= 2) { multiplier = 0.5; textType = 'weak'; }
                else if (finalRoll <= 4) { multiplier = 1.0; textType = 'normal'; }
                else if (finalRoll === 5) { multiplier = 1.2; textType = 'crit'; }
                else { multiplier = 1.5; textType = 'perfect'; }

                setTimeout(() => {
                    setPhase('executing');

                    if (selectedAttack.type === 'heal') {
                        const healAmount = Math.floor(selectedAttack.baseDmg * multiplier);
                        setPlayers(prev => prev.map(p => {
                            if (p.hp > 0) {
                                triggerEffect(p.id, 'heal'); // 播放治疗光环
                                showFloatingText(p.id, `+${healAmount}`, 'heal');
                                return { ...p, hp: Math.min(p.maxHp, p.hp + healAmount) };
                            }
                            return p;
                        }));
                        let desc = textType === 'perfect' ? '(舞姿绝美!)' : textType === 'weak' ? '(差点摔倒)' : '';
                        addLog(`骰子 [${finalRoll}] -> 全队恢复了 ${healAmount} 点生命 ${desc}`);
                    } 
                    else if (selectedTarget) {
                        let finalDamage = Math.floor(selectedAttack.baseDmg * multiplier);
                        let extraDesc = '';

                        if (selectedAttack.name === '突刺' && finalRoll >= 4) {
                            finalDamage *= 2; extraDesc = '(触发二连刺!)'; textType = 'crit';
                        }

                        setEnemies(prev => prev.map(e => 
                            e.id === selectedTarget.id ? { ...e, hp: Math.max(0, e.hp - finalDamage) } : e
                        ));

                        triggerEffect(selectedTarget.id, 'slash'); // 播放斩击特效
                        triggerEffect(selectedTarget.id, 'shake'); // 播放震动

                        showFloatingText(selectedTarget.id, finalDamage, textType);
                        
                        let desc = textType === 'weak' ? '(偏斜)' : textType === 'perfect' ? '(完美一击!)' : '';
                        addLog(`骰子 [${finalRoll}] -> 对 ${selectedTarget.name} 造成 ${finalDamage} 点伤害 ${desc} ${extraDesc}`);
                    }

                    setTimeout(advanceTurn, 1200);
                }, 500);
            };

            // --- 优化后的 NPC AI 回合 ---
            useEffect(() => {
                if (phase === 'idle' && activeUnit?.type === 'enemy') {
                    setPhase('executing');
                    addLog(`${activeUnit.name} 正在准备攻击...`);
                    
                    setTimeout(() => {
                        const alivePlayers = players.filter(p => p.hp > 0);
                        if (alivePlayers.length > 0) {
                            // 智能寻敌AI：70%概率攻击血量比例最低的玩家（找弱点），30%概率随机
                            let target = alivePlayers[0];
                            if (Math.random() < 0.7) {
                                let minHpRatio = target.hp / target.maxHp;
                                alivePlayers.forEach(p => {
                                    if (p.hp / p.maxHp < minHpRatio) {
                                        minHpRatio = p.hp / p.maxHp;
                                        target = p;
                                    }
                                });
                            } else {
                                target = alivePlayers[randomInt(0, alivePlayers.length - 1)];
                            }

                            // 随机使用自带的技能或者普通攻击
                            const usedSkill = (activeUnit.skills && activeUnit.skills.length > 0) 
                                ? activeUnit.skills[randomInt(0, activeUnit.skills.length - 1)] 
                                : '突袭';

                            // 伤害计算与暴击判定
                            const baseDmg = Math.floor(activeUnit.atkBase * (randomInt(9, 12) / 10));
                            const isCrit = Math.random() < 0.2; // NPC拥有20%暴击率
                            const dmgToApply = isCrit ? Math.floor(baseDmg * 1.5) : baseDmg;
                            const actualDmg = Math.max(0, dmgToApply - (target.armor || 0));

                            setPlayers(prev => prev.map(p => 
                                p.id === target.id ? { ...p, hp: Math.max(0, p.hp - actualDmg) } : p
                            ));

                            // 触发表现层
                            triggerEffect(target.id, 'slash');
                            triggerEffect(target.id, 'shake');
                            showFloatingText(target.id, actualDmg, isCrit ? 'crit' : 'damage');
                            
                            addLog(`${activeUnit.name} 使用了 [${usedSkill}] 攻击 ${target.name}！造成 ${actualDmg} 伤害${isCrit ? ' (暴击!)' : ''}`);
                        }
                        
                        setTimeout(advanceTurn, 1200);
                    }, 1500);
                }
            }, [phase, activeUnit]);

            const startGame = () => { setPhase('idle'); };

            const HealthBar = ({ current, max, isEnemy }) => (
                <div className="w-full bg-stone-900 h-3 rounded-full border border-stone-600 overflow-hidden relative mt-1">
                    <div className={`h-full transition-all duration-500 ease-out ${isEnemy ? 'bg-red-600' : 'bg-green-600'}`} style={{ width: `${(current / max) * 100}%` }} />
                    <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white tracking-wider shadow-sm">
                        {current} / {max}
                    </div>
                </div>
            );

            // 渲染队伍的卡片列表
            const renderUnitCard = (unit, isEnemy) => {
                const isActive = activeUnitId === unit.id && phase !== 'start' && phase !== 'win' && phase !== 'lose';
                const isDead = unit.hp <= 0;
                const canBeTargeted = phase === 'target-selection' && isEnemy && !isDead;
                
                // 筛选当前单位对应的特效
                const activeUnitEffects = visualEffects.filter(e => e.unitId === unit.id);
                const hasShake = activeUnitEffects.some(e => e.type === 'shake');
                
                return (
                    <div 
                        key={unit.id}
                        onClick={() => canBeTargeted && handleTargetSelect(unit)}
                        className={`
                            relative w-48 bg-stone-800/90 backdrop-blur-sm border-2 rounded-lg p-3 transition-all duration-300 transform
                            ${isActive && !isEnemy && !hasShake ? 'border-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.3)] scale-105' : 'border-stone-600'}
                            ${isActive && isEnemy && !hasShake ? 'border-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.3)] scale-105' : ''}
                            ${canBeTargeted && !hasShake ? 'cursor-pointer hover:border-rose-400 hover:scale-110 shadow-[0_0_20px_rgba(244,63,94,0.4)]' : ''}
                            ${isDead ? 'opacity-40 grayscale scale-95' : ''}
                            ${hasShake ? 'shake-effect border-red-500 shadow-[0_0_20px_rgba(220,38,38,0.6)]' : ''} 
                        `}
                    >
                        {/* 渲染视觉覆盖特效 (斩击/治疗) */}
                        {activeUnitEffects.map(effect => (
                            effect.type === 'slash' ? <div key={effect.id} className="slash-effect"></div> :
                            effect.type === 'heal' ? <div key={effect.id} className="heal-effect"></div> : null
                        ))}

                        <div className="absolute -top-10 left-0 w-full flex justify-center pointer-events-none z-50">
                            {floatingTexts.filter(ft => ft.unitId === unit.id).map(ft => (
                                <div key={ft.id} className={`
                                    absolute animate-bounce-short text-2xl font-black drop-shadow-md
                                    ${ft.type === 'weak' ? 'text-gray-400 text-lg' : ''}
                                    ${ft.type === 'normal' ? 'text-white' : ''}
                                    ${ft.type === 'crit' ? 'text-amber-400 scale-125' : ''}
                                    ${ft.type === 'perfect' ? 'text-red-500 scale-150' : ''}
                                    ${ft.type === 'damage' ? 'text-red-600' : ''}
                                    ${ft.type === 'heal' ? 'text-green-400 scale-110' : ''}
                                `}>
                                    {ft.value}
                                </div>
                            ))}
                        </div>
                        
                        {canBeTargeted && (
                            <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 animate-bounce text-rose-500 z-20">
                                <Icons.Target />
                            </div>
                        )}

                        <div className="flex justify-between items-start mb-2">
                            <h3 className={`font-bold text-sm truncate ${isEnemy ? 'text-rose-100' : 'text-amber-100'}`}>{unit.name}</h3>
                            {!isEnemy && (
                                <div className="flex gap-0.5">
                                    {[1,2].map(i => <div key={i} className="w-1.5 h-1.5 rounded-full bg-amber-400 shadow-sm" />)}
                                </div>
                            )}
                        </div>
                        <div className="flex justify-center my-2 transform transition-transform hover:scale-105 cursor-default drop-shadow-lg">
                            {unit.img}
                        </div>
                        <div className="space-y-1">
                            <HealthBar current={unit.hp} max={unit.maxHp} isEnemy={isEnemy} />
                        </div>
                    </div>
                );
            };

            return (
                <div className="w-full min-h-screen bg-slate-950 text-stone-200 font-sans selection:bg-amber-500/30 flex items-center justify-center p-4">
                    <div className="w-full max-w-5xl bg-stone-800 rounded-xl shadow-2xl border-4 border-stone-700 overflow-hidden relative flex flex-col min-h-[650px]">
                        
                        {/* 顶部 HUD */}
                        <div className="bg-stone-900 z-20 p-3 flex justify-between items-center border-b border-stone-700 shadow-md">
                            <div className="flex items-center gap-3">
                                <div className={`px-3 py-1 rounded text-xs font-bold tracking-widest ${activeUnit?.type === 'player' && phase !== 'start' ? 'bg-amber-600 text-white animate-pulse' : 'bg-stone-800 text-stone-400'}`}>
                                    玩家阶段
                                </div>
                                <div className="flex gap-1 items-center">
                                    {turnQueue.map((id, idx) => (
                                        <div key={idx} className={`w-2 h-2 rounded-full ${idx === turnIndex ? (activeUnit?.type==='player'?'bg-amber-400':'bg-rose-500') : 'bg-stone-600'}`} />
                                    ))}
                                </div>
                                <div className={`px-3 py-1 rounded text-xs font-bold tracking-widest ${activeUnit?.type === 'enemy' && phase !== 'start' ? 'bg-rose-800 text-white animate-pulse' : 'bg-stone-800 text-stone-400'}`}>
                                    敌方阶段
                                </div>
                            </div>
                            <div className="text-stone-400 text-xs font-mono">FTK COMBAT V2 // ENHANCED FX</div>
                        </div>

                        {/* 战斗场景 */}
                        <div className="flex-1 relative overflow-hidden flex justify-between items-center perspective-1000 bg-stone-900 px-8 py-4">
                            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-stone-700 via-stone-900 to-black opacity-100 z-0"></div>
                            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-40 mix-blend-overlay z-0"></div>
                            <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
                                <div className="particle p1"></div><div className="particle p2"></div>
                                <div className="particle p3"></div><div className="particle p4"></div>
                            </div>

                            <div className="relative z-10 w-full h-full flex justify-between items-center">
                                
                                <div className="flex flex-col gap-4">
                                    {players.map(p => renderUnitCard(p, false))}
                                </div>

                                <div className="flex flex-col items-center justify-center w-48 flex-shrink-0">
                                    {showDice ? (
                                        <div className="animate-in fade-in zoom-in duration-300 flex flex-col items-center">
                                            <div className={`
                                                w-20 h-20 bg-amber-100 rounded-xl border-4 border-amber-600 
                                                flex items-center justify-center text-4xl font-black text-amber-800 shadow-[0_10px_30px_rgba(0,0,0,0.5)]
                                                ${phase === 'rolling' ? 'animate-spin-slow' : ''}
                                            `}>
                                                {diceValue}
                                            </div>
                                            <div className="mt-4 text-center bg-black/40 p-2 rounded backdrop-blur-sm">
                                                <p className="text-[10px] font-bold text-amber-400 uppercase tracking-widest">Roll Result</p>
                                                <p className="text-xs text-stone-300 mt-1">
                                                    {diceValue <= 2 ? '0.5x (偏斜)' : diceValue === 6 ? '1.5x (暴击!)' : diceValue === 5 ? '1.2x (重击)' : '1.0x (命中)'}
                                                </p>
                                            </div>
                                        </div>
                                    ) : (
                                        (phase === 'win' || phase === 'lose') ? (
                                            <div className="text-center">
                                                <h2 className={`text-4xl font-black mb-2 drop-shadow-lg ${phase === 'win' ? 'text-amber-400' : 'text-red-500'}`}>
                                                    {phase === 'win' ? 'VICTORY' : 'DEFEAT'}
                                                </h2>
                                                <button onClick={() => window.location.reload()} className="flex items-center gap-2 bg-stone-200 text-stone-900 px-6 py-2 rounded-full font-bold hover:bg-white hover:scale-105 transition-all shadow-lg mx-auto mt-4 text-sm">
                                                    <Icons.RotateCcw /> 重置演示
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="text-stone-500 font-bold text-2xl opacity-20 select-none mix-blend-overlay">VS</div>
                                        )
                                    )}
                                </div>

                                <div className="flex flex-col gap-4">
                                    {enemies.map(e => renderUnitCard(e, true))}
                                </div>
                            </div>
                        </div>

                        {/* 底部 HUD */}
                        <div className="h-44 bg-stone-900 border-t-4 border-stone-800 flex z-20 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
                            <div className="w-1/2 p-4 border-r border-stone-800 flex flex-col justify-center">
                                <div className="text-xs font-bold text-stone-500 mb-2 uppercase tracking-wider flex items-center justify-between">
                                    <span className="flex items-center gap-2"><Icons.Sword /> 战斗技能指挥</span>
                                    {activeUnit?.type === 'player' && phase === 'idle' && <span className="text-amber-500 animate-pulse text-[10px]">等待 {activeUnit.name} 指示</span>}
                                </div>
                                
                                {phase === 'start' ? (
                                    <div className="flex justify-center h-full items-center pb-4">
                                        <button onClick={startGame} className="bg-amber-600 hover:bg-amber-500 text-white px-8 py-3 rounded font-bold flex items-center gap-2 animate-pulse shadow-lg text-sm">
                                            <Icons.Play /> 开始战斗
                                        </button>
                                    </div>
                                ) : phase === 'target-selection' ? (
                                     <div className="flex-1 flex flex-col justify-center items-center bg-rose-500/10 border border-dashed border-rose-500/30 rounded-lg pb-2">
                                        <p className="text-rose-400 font-bold text-xs flex items-center gap-2 mb-2">
                                            <Icons.Target /> 请点击右上方的敌人作为目标
                                        </p>
                                        <button onClick={() => setPhase('idle')} className="text-[10px] bg-stone-800 px-3 py-1 rounded hover:bg-stone-700 text-stone-300">
                                            取消施法
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-2 h-full pb-2">
                                        {activeUnit?.type === 'player' ? activeUnit.attacks.map(attack => (
                                            <button
                                                key={attack.id}
                                                disabled={phase !== 'idle'}
                                                onClick={() => handleAttackSelect(attack)}
                                                className={`
                                                    relative px-3 py-1.5 rounded-lg border-2 flex items-center gap-2 transition-all text-left group
                                                    ${phase === 'idle' 
                                                    ? 'bg-stone-800 border-stone-600 hover:border-amber-500 hover:bg-stone-750 cursor-pointer text-stone-200 shadow-md' 
                                                    : 'bg-stone-900 border-stone-800 text-stone-600 cursor-not-allowed grayscale'}
                                                `}
                                            >
                                                <div className={`p-1 rounded-md ${phase === 'idle' ? 'bg-stone-700 text-amber-400 group-hover:text-amber-300' : 'bg-stone-800 text-stone-600'}`}>
                                                    {attack.icon}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-bold truncate">{attack.name}</div>
                                                    <div className="text-[9px] opacity-60 truncate">{attack.desc}</div>
                                                </div>
                                                <div className="text-[9px] font-mono absolute top-1 right-2 opacity-30">
                                                    {attack.type === 'heal' ? 'HEAL' : 'DMG'} {attack.baseDmg}
                                                </div>
                                            </button>
                                        )) : (
                                            <div className="col-span-2 flex items-center justify-center text-xs text-stone-600 font-mono tracking-widest pb-4">
                                                ENEMY TURN COMPUTING...
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            <div className="w-1/2 p-4 bg-black/20 overflow-hidden flex flex-col">
                                <div className="text-xs font-bold text-stone-500 mb-2 uppercase tracking-wider">战斗记录</div>
                                <div className="flex-1 overflow-y-auto space-y-1.5 custom-scrollbar pr-2">
                                    {logs.map((log, i) => (
                                        <div key={i} className={`text-xs py-1 border-b border-white/5 ${i === 0 ? 'text-amber-100 font-medium' : 'text-stone-500'}`}>
                                            <span className="opacity-30 mr-2">[{logs.length - i}]</span>
                                            {log}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>